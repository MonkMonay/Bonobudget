<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Bonobudget</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:700&display=swap">
    <style>
        body { background: #111; color: #fff; font-family: 'Montserrat', Arial, sans-serif; margin: 0; }
        .header { background: #222; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-radius: 0 0 20px 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #4caf50; }
        .nav { display: flex; gap: 30px; }
        .nav-item { color: #ccc; text-decoration: none; padding: 12px 20px; border-radius: 15px; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover { background: #333; color: #fff; }
        .nav-item.active { background: #4caf50; color: #fff; }
        .profile { display: flex; align-items: center; gap: 15px; }
        .profile-email { color: #ccc; }
        .logout-btn { background: #ff5252; color: #fff; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; transition: background 0.2s; }
        .logout-btn:hover { background: #d32f2f; }
        .container { padding: 30px; }
        .welcome { background: #222; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        h1 { margin: 0 0 10px 0; color: #4caf50; }
        .welcome-text { color: #ccc; font-size: 18px; }
        .returntoindex { text-decoration: none; color: #4caf50; }
        .returntoindex:hover, .returntoindex:visited, .returntoindex:active { color: #4caf50; }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo"><a href="https://bonobudget.com" style="text-decoration: none; color: #4caf50;"  id="returntoindex">Bonobudget</a></div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    <div class="container">
        <div class="welcome" style="margin-bottom: 60px;">
            <h1>Welcome to your Dashboard</h1>
            <div class="welcome-text" id="welcome"></div>
        </div>
        <h2 style="color:#FFD700;text-align:center;margin-top:40px;">Your Expenses Summary</h2>
        <div id="sankey_chart" style="width:100%;max-width:1200px;margin:0 auto;background:#222;border-radius:16px;padding:20px;min-height:600px;overflow-x:auto;"></div>
    </div>
    <style>
        .sankey-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 500px;
            padding: 20px;
            position: relative;
        }
        
        .sankey-column {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 120px;
        }
        
        .sankey-node {
            background: #4a90e2;
            border-radius: 4px;
            margin: 2px 0;
            padding: 8px 12px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            position: relative;
            white-space: nowrap;
        }
        
        .sankey-node.income { background: #7cb342; }
        .sankey-node.budget { background: #1976d2; }
        .sankey-node.taxes { background: #ff9800; }
        .sankey-node.housing { background: #8d6e63; }
        .sankey-node.transportation { background: #4caf50; }
        .sankey-node.food { background: #607d8b; }
        .sankey-node.personal { background: #9c27b0; }
        .sankey-node.entertainment { background: #00bcd4; }
        .sankey-node.financial { background: #ff5722; }
        .sankey-node.other { background: #795548; }
        
        .sankey-connection {
            position: absolute;
            background: rgba(255, 215, 0, 0.6);
            border-radius: 2px;
            z-index: 1;
        }
        
        .sankey-label {
            position: absolute;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 2;
        }
    </style>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate & Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    // Category colors
    const categoryColors = {
        'Income': '#7cb342',
        'Housing': '#8d6e63',
        'Transportation': '#4caf50',
        'Food & Dining': '#607d8b',
        'Personal & Health': '#9c27b0',
        'Entertainment & Lifestyle': '#00bcd4',
        'Financial Obligations': '#ff5722',
        'Other': '#795548'
    };

    auth.onAuthStateChanged(function(user) {
        if (user) {
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            loadSankeyData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });
    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function loadSankeyData(uid) {
        db.collection('users').doc(uid).collection('spending').doc('categories').get().then(doc => {
            if (!doc.exists) {
                console.log('No spending data found');
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
                return;
            }
            const data = doc.data();
            console.log('Loaded data:', data);
            
            // Calculate income sources
            const incomeSources = [];
            const primaryIncome = parseFloat(data['Primary Monthly Income']) || 0;
            const additionalIncome = parseFloat(data['Additional Monthly Income']) || 0;
            
            if (primaryIncome > 0) {
                incomeSources.push({
                    name: data['Primary Income Source'] || 'Primary Income',
                    amount: primaryIncome * 12
                });
            }
            
            if (additionalIncome > 0) {
                incomeSources.push({
                    name: 'Additional Income',
                    amount: additionalIncome * 12
                });
            }
            
            const irregularIncome = parseFloat(data['Annual Irregular Income']) || 0;
            if (irregularIncome > 0) {
                incomeSources.push({
                    name: 'Irregular Income',
                    amount: irregularIncome
                });
            }
            
            // Calculate category totals and subcategory totals
            const categoryTotals = {};
            const subcategoryTotals = {};
            
            for (const category of spendingCategories) {
                if (category.title === 'Income') continue;
                
                let categoryTotal = 0;
                for (const item of category.items) {
                    const value = data[item.label];
                    if (value && value !== 'skipped' && !isNaN(parseFloat(value))) {
                        const numValue = parseFloat(value);
                        categoryTotal += numValue;
                        subcategoryTotals[item.label] = numValue;
                    }
                }
                
                // Handle special case for mortgage principal
                if (category.title === 'Housing') {
                    const mortgagePrincipal = parseFloat(data['Mortgage Principal']) || 0;
                    categoryTotal += mortgagePrincipal;
                    if (mortgagePrincipal > 0) {
                        subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                    }
                }
                
                if (categoryTotal > 0) {
                    categoryTotals[category.title] = categoryTotal;
                }
            }
            
            console.log('Income sources:', incomeSources);
            console.log('Category totals:', categoryTotals);
            console.log('Subcategory totals:', subcategoryTotals);
            
            createSankeyChart(incomeSources, categoryTotals, subcategoryTotals);
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error loading data. Please try again.</div>';
        });
    }

    function createSankeyChart(incomeSources, categoryTotals, subcategoryTotals) {
        const chartContainer = document.getElementById('sankey_chart');
        
        if (incomeSources.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
            return;
        }

        const totalIncome = incomeSources.reduce((sum, source) => sum + source.amount, 0);
        const totalSpending = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0) * 12;
        
        let html = '<div class="sankey-container">';
        
        // Income sources column
        html += '<div class="sankey-column">';
        for (const source of incomeSources) {
            const height = (source.amount / totalIncome) * 400;
            html += `<div class="sankey-node income" style="height: ${height}px; line-height: ${height}px;">`;
            html += `${source.name}<br>$${source.amount.toLocaleString()}`;
            html += '</div>';
        }
        html += '</div>';
        
        // Budget column
        html += '<div class="sankey-column">';
        html += `<div class="sankey-node budget" style="height: 400px; line-height: 400px;">`;
        html += `Budget<br>$${totalIncome.toLocaleString()}`;
        html += '</div>';
        html += '</div>';
        
        // Categories column
        html += '<div class="sankey-column">';
        for (const category in categoryTotals) {
            const categoryTotal = categoryTotals[category];
            const height = (categoryTotal * 12 / totalIncome) * 400;
            const colorClass = category.toLowerCase().replace(/\s+/g, '');
            html += `<div class="sankey-node ${colorClass}" style="height: ${height}px; line-height: ${height}px;">`;
            html += `${category}<br>$${(categoryTotal * 12).toLocaleString()}`;
            html += '</div>';
        }
        html += '</div>';
        
        // Subcategories column
        html += '<div class="sankey-column">';
        for (const category in categoryTotals) {
            const categoryTotal = categoryTotals[category];
            const categoryHeight = (categoryTotal * 12 / totalIncome) * 400;
            const colorClass = category.toLowerCase().replace(/\s+/g, '');
            
            // Find subcategories for this category
            const subcategories = [];
            for (const subcategory in subcategoryTotals) {
                for (const cat of spendingCategories) {
                    if (cat.title === category) {
                        const found = cat.items.find(item => item.label === subcategory);
                        if (found) {
                            subcategories.push({
                                name: subcategory,
                                amount: subcategoryTotals[subcategory] * 12
                            });
                        }
                        break;
                    }
                }
            }
            
            // Create subcategory nodes
            let currentY = 0;
            for (const sub of subcategories) {
                const subHeight = (sub.amount / totalIncome) * 400;
                html += `<div class="sankey-node ${colorClass}" style="height: ${subHeight}px; line-height: ${subHeight}px; margin-top: ${currentY}px;">`;
                html += `${sub.name}<br>$${sub.amount.toLocaleString()}`;
                html += '</div>';
                currentY += subHeight + 2;
            }
        }
        html += '</div>';
        
        html += '</div>';
        
        chartContainer.innerHTML = html;
    }
</script>
</body>
</html> 