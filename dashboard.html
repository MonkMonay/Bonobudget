<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Bonobudget</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:700&display=swap">
    <style>
        body { background: #111; color: #fff; font-family: 'Montserrat', Arial, sans-serif; margin: 0; }
        .header { background: #222; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-radius: 0 0 20px 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #4caf50; }
        .nav { display: flex; gap: 30px; }
        .nav-item { color: #ccc; text-decoration: none; padding: 12px 20px; border-radius: 15px; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover { background: #333; color: #fff; }
        .nav-item.active { background: #4caf50; color: #fff; }
        .profile { display: flex; align-items: center; gap: 15px; }
        .profile-email { color: #ccc; }
        .logout-btn { background: #ff5252; color: #fff; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; transition: background 0.2s; }
        .logout-btn:hover { background: #d32f2f; }
        .container { padding: 30px; }
        .welcome { background: #222; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        h1 { margin: 0 0 10px 0; color: #4caf50; }
        .welcome-text { color: #ccc; font-size: 18px; }
        .returntoindex { text-decoration: none; color: #4caf50; }
        .returntoindex:hover, .returntoindex:visited, .returntoindex:active { color: #4caf50; }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo"><a href="https://bonobudget.com" style="text-decoration: none; color: #4caf50;"  id="returntoindex">Bonobudget</a></div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    <div class="container">
        <div class="welcome" style="margin-bottom: 60px;">
            <h1>Welcome to your Dashboard</h1>
            <div class="welcome-text" id="welcome"></div>
        </div>
        <h2 style="color:#FFD700;text-align:center;margin-top:40px;">Your Expenses Summary</h2>
        <div id="expense_chart" style="width:100%;max-width:900px;margin:0 auto;background:#222;border-radius:16px;padding:20px;min-height:400px;"></div>
    </div>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate" },
            { label: "Mortgage Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    // Category colors
    const categoryColors = {
        'Income': '#4caf50',
        'Housing': '#2196f3',
        'Transportation': '#ff9800',
        'Food & Dining': '#e91e63',
        'Personal & Health': '#9c27b0',
        'Entertainment & Lifestyle': '#00bcd4',
        'Financial Obligations': '#ff5722',
        'Other': '#607d8b'
    };

    auth.onAuthStateChanged(function(user) {
        if (user) {
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            loadExpenseData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });
    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function loadExpenseData(uid) {
        db.collection('users').doc(uid).collection('spending').doc('categories').get().then(doc => {
            if (!doc.exists) {
                console.log('No spending data found');
                document.getElementById('expense_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
                return;
            }
            const data = doc.data();
            console.log('Loaded data:', data);
            
            // Calculate category totals and subcategory totals
            const categoryTotals = {};
            const subcategoryTotals = {};
            let totalIncome = 0;
            
            // Process each category
            for (const category of spendingCategories) {
                if (category.title === 'Income') {
                    // Handle income separately
                    const monthlyIncome = parseFloat(data['Total Monthly Income']) || 0;
                    const irregularIncome = parseFloat(data['Annual Irregular Income']) || 0;
                    totalIncome = (monthlyIncome * 12) + irregularIncome;
                    continue;
                }
                
                // Calculate total for each spending category
                let categoryTotal = 0;
                for (const item of category.items) {
                    const value = data[item.label];
                    if (value && value !== 'skipped' && !isNaN(parseFloat(value))) {
                        const numValue = parseFloat(value);
                        categoryTotal += numValue;
                        subcategoryTotals[item.label] = numValue;
                    }
                }
                
                // Handle special case for mortgage principal
                if (category.title === 'Housing') {
                    const mortgagePrincipal = parseFloat(data['Mortgage Principal']) || 0;
                    categoryTotal += mortgagePrincipal;
                    if (mortgagePrincipal > 0) {
                        subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                    }
                }
                
                if (categoryTotal > 0) {
                    categoryTotals[category.title] = categoryTotal;
                }
            }
            
            console.log('Category totals:', categoryTotals);
            console.log('Subcategory totals:', subcategoryTotals);
            console.log('Total income:', totalIncome);
            
            createExpenseChart(categoryTotals, subcategoryTotals, totalIncome);
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('expense_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error loading data. Please try again.</div>';
        });
    }

    function createExpenseChart(categoryTotals, subcategoryTotals, totalIncome) {
        const chartContainer = document.getElementById('expense_chart');
        
        if (Object.keys(categoryTotals).length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
            return;
        }

        let html = '<div style="text-align: center; margin-bottom: 20px;">';
        html += `<div style="font-size: 24px; color: #4caf50; margin-bottom: 10px;">Total Annual Income: $${totalIncome.toLocaleString()}</div>`;
        html += '</div>';
        
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
        
        for (const category in categoryTotals) {
            const categoryTotal = categoryTotals[category];
            const percentage = ((categoryTotal * 12) / totalIncome * 100).toFixed(1);
            const color = categoryColors[category] || '#666';
            
            html += `<div style="background: #333; border-radius: 10px; padding: 15px; border-left: 4px solid ${color};">`;
            html += `<div style="font-size: 18px; font-weight: bold; color: ${color}; margin-bottom: 10px;">${category}</div>`;
            html += `<div style="font-size: 14px; color: #ccc; margin-bottom: 15px;">Annual: $${(categoryTotal * 12).toLocaleString()} (${percentage}%)</div>`;
            
            // Add subcategories
            html += '<div style="font-size: 12px; color: #999;">';
            for (const subcategory in subcategoryTotals) {
                // Find which category this subcategory belongs to
                for (const cat of spendingCategories) {
                    if (cat.title === category) {
                        const found = cat.items.find(item => item.label === subcategory);
                        if (found) {
                            const subValue = subcategoryTotals[subcategory];
                            const subPercentage = ((subValue * 12) / totalIncome * 100).toFixed(1);
                            html += `<div style="margin: 5px 0; padding: 5px; background: #444; border-radius: 5px;">`;
                            html += `<span style="color: #ccc;">${subcategory}</span>`;
                            html += `<span style="float: right; color: ${color};">$${(subValue * 12).toLocaleString()} (${subPercentage}%)</span>`;
                            html += '</div>';
                        }
                        break;
                    }
                }
            }
            html += '</div>';
            html += '</div>';
        }
        
        html += '</div>';
        
        chartContainer.innerHTML = html;
    }
</script>
</body>
</html> 