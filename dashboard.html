<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Bonobudget</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:700&display=swap">
    <style>
        body { background: #111; color: #fff; font-family: 'Montserrat', Arial, sans-serif; margin: 0; }
        .header { background: #222; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-radius: 0 0 20px 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #4caf50; }
        .nav { display: flex; gap: 30px; }
        .nav-item { color: #ccc; text-decoration: none; padding: 12px 20px; border-radius: 15px; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover { background: #333; color: #fff; }
        .nav-item.active { background: #4caf50; color: #fff; }
        .profile { display: flex; align-items: center; gap: 15px; }
        .profile-email { color: #ccc; }
        .logout-btn { background: #ff5252; color: #fff; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; transition: background 0.2s; }
        .logout-btn:hover { background: #d32f2f; }
        .container { padding: 30px; }
        .welcome { background: #222; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        h1 { margin: 0 0 10px 0; color: #4caf50; }
        .welcome-text { color: #ccc; font-size: 18px; }
        .returntoindex { text-decoration: none; color: #4caf50; }
        .returntoindex:hover, .returntoindex:visited, .returntoindex:active { color: #4caf50; }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo"><a href="https://bonobudget.com" style="text-decoration: none; color: #4caf50;"  id="returntoindex">Bonobudget</a></div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    <div class="container">
        <div class="welcome" style="margin-bottom: 60px;">
            <h1>Welcome to your Dashboard</h1>
            <div class="welcome-text" id="welcome"></div>
        </div>
        <h2 style="color:#FFD700;text-align:center;margin-top:40px;">Your Financial Flow</h2>
        <div id="sankey_chart" style="width:100%;height:600px;margin:0 auto;background:#222;border-radius:16px;padding:20px;"></div>
    </div>
    <!-- D3.js and D3 Sankey -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        .node rect {
            stroke: #333;
            cursor: pointer;
        }
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-family: 'Montserrat', Arial, sans-serif;
            fill: #fff;
        }
        .link {
            fill: none;
            stroke-opacity: 0.6;
        }
        .link:hover {
            stroke-opacity: 0.9;
        }
    </style>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate" },
            { label: "Mortgage Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    auth.onAuthStateChanged(function(user) {
        if (user) {
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            loadSankeyData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });
    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function loadSankeyData(uid) {
        db.collection('users').doc(uid).collection('spending').doc('categories').get().then(doc => {
            if (!doc.exists) {
                console.log('No spending data found');
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
                return;
            }
            const data = doc.data();
            console.log('Loaded data:', data);
            
            // Calculate income sources
            const incomeSources = [];
            const primaryIncome = parseFloat(data['Primary Monthly Income']) || 0;
            const additionalIncome = parseFloat(data['Additional Monthly Income']) || 0;
            
            if (primaryIncome > 0) {
                incomeSources.push({
                    name: data['Primary Income Source'] || 'Primary Income',
                    amount: primaryIncome * 12
                });
            }
            
            if (additionalIncome > 0) {
                incomeSources.push({
                    name: 'Additional Income',
                    amount: additionalIncome * 12
                });
            }
            
            const irregularIncome = parseFloat(data['Annual Irregular Income']) || 0;
            if (irregularIncome > 0) {
                incomeSources.push({
                    name: 'Irregular Income',
                    amount: irregularIncome
                });
            }
            
            // If no income sources found, use total income
            if (incomeSources.length === 0) {
                const totalMonthlyIncome = parseFloat(data['Total Monthly Income']) || 0;
                if (totalMonthlyIncome > 0) {
                    incomeSources.push({
                        name: 'Total Income',
                        amount: totalMonthlyIncome * 12
                    });
                }
            }
            
            // Calculate category totals and subcategory totals
            const categoryTotals = {};
            const subcategoryTotals = {};
            
            for (const category of spendingCategories) {
                if (category.title === 'Income') continue;
                
                let categoryTotal = 0;
                for (const item of category.items) {
                    const value = data[item.label];
                    // Skip Mortgage Principal as it's handled separately
                    if (item.label === 'Mortgage Principal') continue;
                    
                    if (value && value !== 'skipped' && !isNaN(parseFloat(value))) {
                        const numValue = parseFloat(value);
                        categoryTotal += numValue;
                        subcategoryTotals[item.label] = numValue;
                    }
                }
                
                // Handle special case for mortgage principal
                if (category.title === 'Housing') {
                    const mortgagePrincipal = parseFloat(data['Mortgage Principal']) || 0;
                    if (mortgagePrincipal > 0) {
                        categoryTotal += mortgagePrincipal;
                        subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                    }
                }
                
                if (categoryTotal > 0) {
                    categoryTotals[category.title] = categoryTotal;
                }
            }
            
            console.log('Income sources:', incomeSources);
            console.log('Category totals:', categoryTotals);
            console.log('Subcategory totals:', subcategoryTotals);
            
            if (incomeSources.length === 0) {
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No income data found. Please complete the income section of the bank questionnaire.</div>';
                return;
            }
            
            if (Object.keys(categoryTotals).length === 0) {
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data found. Please complete the spending section of the bank questionnaire.</div>';
                return;
            }
            
            createSankeyChart(incomeSources, categoryTotals, subcategoryTotals);
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error loading data. Please try again.</div>';
        });
    }

    function createSankeyChart(incomeSources, categoryTotals, subcategoryTotals) {
        const chartContainer = document.getElementById('sankey_chart');
        
        // Clear previous chart
        chartContainer.innerHTML = '';
        
        // Prepare data for D3 Sankey
        const nodes = [];
        const links = [];
        const nodeNames = new Set(); // Track all node names
        
        // Add income source nodes
        incomeSources.forEach(source => {
            nodes.push({ name: source.name });
            nodeNames.add(source.name);
        });
        
        // Add budget node
        nodes.push({ name: "Budget" });
        nodeNames.add("Budget");
        
        // Add category nodes (only main categories, no subcategories)
        Object.keys(categoryTotals).forEach(category => {
            nodes.push({ name: category });
            nodeNames.add(category);
        });
        
        // Create a mapping from node names to indices
        const nodeNameToIndex = {};
        nodes.forEach((node, index) => {
            nodeNameToIndex[node.name] = index;
        });
        
        // Create links from income sources to budget
        const totalIncome = incomeSources.reduce((sum, source) => sum + source.amount, 0);
        incomeSources.forEach(source => {
            if (nodeNames.has(source.name) && nodeNames.has("Budget")) {
                links.push({
                    source: nodeNameToIndex[source.name],
                    target: nodeNameToIndex["Budget"],
                    value: source.amount
                });
            }
        });
        
        // Create links from budget to categories
        Object.keys(categoryTotals).forEach(category => {
            if (nodeNames.has("Budget") && nodeNames.has(category)) {
                links.push({
                    source: nodeNameToIndex["Budget"],
                    target: nodeNameToIndex[category],
                    value: categoryTotals[category] * 12
                });
            }
        });
        
        console.log('Sankey nodes:', nodes.map(n => n.name));
        console.log('Sankey links:', links.map(l => `${nodes[l.source].name} → ${nodes[l.target].name}`));
        
        // Validate that all links reference existing nodes
        const validLinks = links.filter(link => {
            const sourceExists = link.source >= 0 && link.source < nodes.length;
            const targetExists = link.target >= 0 && link.target < nodes.length;
            if (!sourceExists || !targetExists) {
                console.warn(`Removing invalid link: ${nodes[link.source]?.name || 'unknown'} → ${nodes[link.target]?.name || 'unknown'}`);
                return false;
            }
            return true;
        });
        
        console.log('Valid links count:', validLinks.length);
        
        if (validLinks.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No valid data connections found. Please complete the bank questionnaire with both income and spending data.</div>';
            return;
        }
        
        // Create the chart
        const width = chartContainer.clientWidth - 40; // Account for padding
        const height = 560; // Account for padding
        
        const svg = d3.select("#sankey_chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        
        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(40)
            .extent([[1, 1], [width - 1, height - 6]]);
        
        try {
            console.log('About to create Sankey with nodes:', nodes.length, 'and links:', validLinks.length);
            
            const {nodes: sankeyNodes, links: sankeyLinks} = sankey({
                nodes: nodes,
                links: validLinks
            });
            
            const color = d3.scaleOrdinal()
                .domain(nodes.map(d => d.name))
                .range(d3.schemeCategory10);
            
            // Create links
            svg.append("g")
                .selectAll("path")
                .data(sankeyLinks)
                .join("path")
                    .attr("class", "link")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .attr("stroke", d => color(d.source.name))
                    .attr("stroke-width", d => Math.max(1, d.width))
                    .append("title")
                    .text(d => `${d.source.name} → ${d.target.name}\n$${d.value.toLocaleString()}`);
            
            // Create nodes
            const node = svg.append("g")
                .selectAll("g")
                .data(sankeyNodes)
                .join("g")
                    .attr("class", "node");
            
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", d => color(d.name));
            
            node.append("text")
                .attr("x", d => d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .text(d => d.name)
                .filter(d => d.x0 < width / 2)
                .attr("x", d => d.x1 + 6)
                .attr("text-anchor", "start");
                
        } catch (error) {
            console.error('Error creating Sankey chart:', error);
            console.error('Error details:', error.message);
            chartContainer.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error creating chart. Please check the console for details.</div>';
        }
    }
</script>
</body>
</html> 